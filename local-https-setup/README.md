# Local HTTPS Development Setup

This folder contains all the scripts and configuration files needed to run the Marine Licensing Frontend application locally with HTTPS support and on how to point local to cp dev defra id instance instead of stub.

## üöÄ Quick Start

### Prerequisites

1. **Install mkcert** (for local SSL certificates):

   ```bash
   brew install mkcert
   mkcert -install
   ```

2. **Install nginx** (if not already installed):

   ```bash
   brew install nginx
   ```

3. **Set up nginx directories** (required for Homebrew nginx):

   ```bash
   sudo mkdir -p /usr/local/var/run/nginx
   sudo chown -R $(whoami):admin /usr/local/var/run/nginx
   ```

   > **‚ö†Ô∏è Important**: This step is required to set the working directory correctly for Homebrew installed nginx.

4. **Generate SSL certificates** (first time only):

   ```bash
   cd local-https-setup
   mkcert marine-licensing-frontend.test.cdp-int.defra.cloud
   cd ..
   ```

   > **‚ö†Ô∏è Important**: SSL certificates are generated locally and should NOT be committed to the repository. The certificates are already in `.gitignore` to prevent accidental commits.

5. **Enable local DNS** (first time only):

   ```bash
   ./local-https-setup/toggle-local-dns.sh
   ```

6. Create a .env in the frontend repo root for all defra id related changes\*\* (it will be git-ignored) :

```
DEFRA_ID_ACCOUNT_MANAGEMENT_URL=
DEFRA_ID_ENABLED=true
DEFRA_ID_OIDC_CONFIGURATION_URL=
DEFRA_ID_CLIENT_ID=
DEFRA_ID_CLIENT_SECRET=
DEFRA_ID_SERVICE_ID=
AUTH_DEFRA_ID_SCOPES=
APP_BASE_URL=https://marine-licensing-frontend.test.cdp-int.defra.cloud
```

- including AUTH_DEFRA_ID_SCOPES and DEFRA_ID_CLIENT_SECRET from secrets
- use other values from here https://github.com/DEFRA/cdp-app-config/blob/fac3e76ed9485599c2c93868e04863321c60f48a/services/marine-licensing-frontend/test/marine-licensing-frontend.env#L4

7. Create a .env in the backend repo root:

```
DEFRA_ID_JWKS_URI=
DEFRA_ID_ENABLED=true
```

Get the value for `DEFRA_ID_JWKS_URI` from here - https://github.com/DEFRA/cdp-app-config/blob/main/services/marine-licensing-backend/test/marine-licensing-backend.env#L3

### Start the Application

```bash
./local-https-setup/start-with-https.sh
```

## üìÅ Files Overview

### Configuration Files

- **`nginx-https.conf`** - Nginx configuration for HTTP and HTTPS reverse proxy
- **`README.md`** - This documentation file

### Startup Scripts

- **`start-with-https.sh`** - Starts application with HTTPS support
- **`toggle-local-dns.sh`** - Toggle between local and remote DNS resolution
- **`stop-all.sh`** - Stop all running processes and clean up

## üîß How It Works

### Architecture

```
Browser ‚Üí HTTPS (443) ‚Üí Nginx ‚Üí HTTP (3000) ‚Üí Node.js App
Browser ‚Üí HTTP (80)  ‚Üí Nginx ‚Üí HTTP (3000) ‚Üí Node.js App
```

### Components

1. **Nginx Reverse Proxy**: Handles SSL termination and forwards requests to localhost:3000
2. **SSL Certificates**: Generated by mkcert for local development
3. **DNS Resolution**: Local /etc/hosts entry for domain mapping
4. **Environment Variables**: Configured for OIDC and base URL

## üåê Access URLs

Once started, access your application at:

- **HTTP**: `http://marine-licensing-frontend.test.cdp-int.defra.cloud`
- **HTTPS**: `https://marine-licensing-frontend.test.cdp-int.defra.cloud`

## üîÑ DNS Management

### Enable Local Development

```bash
./local-https-setup/toggle-local-dns.sh
```

This will:

- Add `127.0.0.1 marine-licensing-frontend.test.cdp-int.defra.cloud` to /etc/hosts
- Flush DNS cache
- Domain will resolve to localhost

### Disable Local Development (Use Remote)

```bash
./local-https-setup/toggle-local-dns.sh
```

This will:

- Comment out the local DNS entry
- Flush DNS cache
- Domain will resolve to remote test environment

## üõë Stopping the Application

### Graceful Stop

Press `Ctrl+C` in the terminal where the startup script is running.

### Force Stop All Processes

```bash
./local-https-setup/stop-all.sh
```

## üîç Troubleshooting

### SSL Certificate Issues

If you see SSL errors:

1. Ensure mkcert is installed: `brew install mkcert`
2. Install mkcert root CA: `mkcert -install`
3. Generate new certificates:
   ```bash
   cd local-https-setup
   rm -f *.pem  # Remove existing certificates
   mkcert marine-licensing-frontend.test.cdp-int.defra.cloud
   cd ..
   ```
   > **Note**: Each developer should generate their own SSL certificates locally. Never commit certificate files to the repository.

### Port Conflicts

If ports are already in use:

```bash
./local-https-setup/stop-all.sh
```

### DNS Issues

If domain doesn't resolve:

1. Check /etc/hosts entry: `grep marine-licensing-frontend.test.cdp-int.defra.cloud /etc/hosts`
2. Flush DNS cache: `sudo dscacheutil -flushcache && sudo killall -HUP mDNSResponder`
3. Use toggle script: `./local-https-setup/toggle-local-dns.sh`

## üîß Environment Variables

The scripts automatically set these environment variables:

- **`APP_BASE_URL`**: `https://marine-licensing-frontend.test.cdp-int.defra.cloud`

## üìù Manual Commands

If you prefer to run commands manually:

### Start Nginx Only

```bash
sudo nginx -c $(pwd)/local-https-setup/nginx-https.conf
```

### Start Application Only

```bash
export APP_BASE_URL=https://marine-licensing-frontend.test.cdp-int.defra.cloud
npm run dev
```

### Stop Nginx

```bash
sudo nginx -s stop
```

## üîí Security Notes

- SSL certificates are for local development only
- Never use these certificates in production
- The setup uses self-signed certificates generated by mkcert
- Browser may show security warnings - this is normal for local development
- **SSL certificates are NOT committed to the repository** - each developer generates their own locally
- Certificate files (`*.pem`) are excluded via `.gitignore` to prevent accidental commits

## üìû Support

If you encounter issues:

1. Check the troubleshooting section above
2. Verify all prerequisites are installed
3. Ensure no other services are using ports 80, 443, or 3000
4. Check application logs for specific error messages
