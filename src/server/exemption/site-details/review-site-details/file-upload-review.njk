{% extends 'layouts/page.njk' %}
{% from "govuk/components/back-link/macro.njk" import govukBackLink %}
{% from "govuk/components/summary-list/macro.njk" import govukSummaryList %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "cancel-button/macro.njk" import appCancelButton %}
{% from "site-details-map/macro.njk" import appSiteDetailsMap %}
{% from "incomplete-field/macro.njk" import appIncompleteField %}
{% from "govuk/components/inset-text/macro.njk" import govukInsetText %}
{% block pageTitle %}
  Review site details | {{ serviceName }}
{% endblock %}
{% block head %}
  {{ super() }}
{% endblock %}
{% block beforeContent %}
  {{ super() }}
<nav>
  {{ govukBackLink({
  text: "Back",
  href: backLink
}) }}
</nav>
{% endblock %}

  {% block content %}
    <div class="govuk-grid-row">
      <div class="govuk-grid-column-full">
        <span class="govuk-caption-l">{{ projectName }}</span>
        <h1 class="govuk-heading-l">Review site details</h1>

            {% if isMultiSiteJourney and hasIncompleteFields %}

              {% set incompleteWarningText %}
                <p class="govuk-!-margin-bottom-3">The site details you've provided are saved.</p>
                <p class="govuk-!-margin-bottom-3">You must complete all sections marked {{appIncompleteField()}} before you can send your information.</p>
                <p class="govuk-!-margin-bottom-0">If you cannot finish now, you can return to this page later.</p>
              {% endset %}

              {{ govukInsetText({
                html: incompleteWarningText
              }) }}

            {% endif  %}

            {% set multipleSiteRows = [
                {
                    key: {
                      text: "Method of providing site location"
                    },
                    value: {
                      text: multipleSiteDetailsData.method
                    }
                },
                {
                    key: {
                      text: "File type"
                    },
                    value: {
                      text: multipleSiteDetailsData.fileType | default('')
                    }
                },
                {
                    key: {
                      text: "File uploaded"
                    },
                    value: {
                      text: multipleSiteDetailsData.filename | sanitiseFilename
                    }
                }
            ] %}

            {{ govukSummaryList({
                card: {
                    title: {
                        text: "Providing the site location"
                    }
                },
                rows: multipleSiteRows
            }) }}


        {% if isMultiSiteJourney %}

          {% set activityRows = [
              {
                  key: {
                      text: "Are the activity dates the same for every site?"
                  },
                  value: {
                      text: multipleSiteDetailsData.sameActivityDates
                  }
              }
          ] %}

          {% if multipleSiteDetailsData.activityDates %}
              {% set activityRows = (activityRows.push({
                  key: {
                      text: "Activity dates"
                  },
                  value: {
                      text: multipleSiteDetailsData.activityDates
                  }
              }), activityRows) %}
          {% endif %}

          {% set activityRows = (activityRows.push({
              key: {
                  text: "Is the activity description the same for every site?"
              },
              value: {
                  html: multipleSiteDetailsData.sameActivityDescription
              }
          }), activityRows) %}

          {% if multipleSiteDetailsData.activityDescription %}
              {% set activityRows = (activityRows.push({
                  key: {
                      text: "Activity description"
                  },
                  value: {
                      text: multipleSiteDetailsData.activityDescription
                  }
              }), activityRows) %}
          {% endif %}

          {{ govukSummaryList({
              card: {
                  title: {
                      text: "Activity details"
                  }
              },
              rows: activityRows
          }) }}

        {% endif %}


        {% for site in summaryData %}

            {#  This javascript variable is only for testing purposes. #}
            <script nonce='{{ cspNonce }}'>
              var geoJSON{{loop.index}} = {{ site.geoJSON | dump | safe }};
            </script>

          {% set summaryRowsHeading %}
            {% if isMultiSiteJourney %}
              Site {{ site.siteNumber }} details
            {% else %}
              Site details
            {% endif %}
          {% endset %}

          {% set rows = [] %}

          {% if isMultiSiteJourney %}
            {% set _ = rows.push({
              key: { text: "Site name"},
              value: { html: appIncompleteField({text: site.siteName})},
              actions: setSiteDetailsAction(site.siteName, 'site-name', site.siteNumber)
            }) %}
          {% endif %}

          {% if site.showActivityDates %}
            {% set _ = rows.push({
              key: { text: "Activity dates"},
              value: { html: appIncompleteField({text: site.activityDates})},
              actions: setSiteDetailsAction(site.activityDates, 'site-details-activity-dates', site.siteNumber)
            }) %}
          {% endif %}

          {% if site.showActivityDescription %}
            {% set _ = rows.push({
              key: { text: "Activity description"},
              value: { html: appIncompleteField({ text: site.activityDescription })},
              actions: setSiteDetailsAction(site.activityDescription, 'site-details-activity-description', site.siteNumber)
            }) %}
          {% endif %}

          {% set _ = rows.push({
            key: { text: "Map view" },
            value: { html: appSiteDetailsMap(site.siteDetailsData, loop.index0) }
          }) %}

          {{ govukSummaryList({
            card: {
              attributes: {
                id: "site-details-" + site.siteNumber
              },
              title: {
                text: summaryRowsHeading
              }
            },
            rows: rows
        }) }}
        {% endfor %}

        <form method="POST">
          <input type="hidden" name="csrfToken" value="{{ csrfToken }}">
            <div class="govuk-button-group">
              {{ govukButton({
            text: "Save and continue",
            attributes: {
              id: "continue"
            }
          }) }}
              {{ appCancelButton({
            cancelLink: "/exemption/task-list?cancel=site-details"
          }) }}
            </div>
          </form>
        </div>
      </div>
    {% endblock %}
